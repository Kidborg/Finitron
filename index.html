<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat with GPT</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background-color: #000;
            /* –ß–µ—Ä–Ω—ã–π —Ñ–æ–Ω */
            color: #fff;
            /* –ë–µ–ª—ã–π —Ç–µ–∫—Å—Ç */
            margin: 0;
        }

        .chat-container {
            background: linear-gradient(to bottom, #8b0000, #000);
            /* –ì—Ä–∞–¥–∏–µ–Ω—Ç –æ—Ç –±–æ—Ä–¥–æ–≤–æ–≥–æ –¥–æ —á–µ—Ä–Ω–æ–≥–æ */
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(255, 0, 0, 0.5);
            /* –ö—Ä–∞—Å–Ω–∞—è —Ç–µ–Ω—å */
            width: 90%;
            /* –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω—É—é —à–∏—Ä–∏–Ω—É */
            max-width: 2000px;
            /* –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω—É—é —à–∏—Ä–∏–Ω—É */
            padding: 20px;
            display: flex;
            flex-direction: column;
            height: 80vh;
            /* –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—É—é –≤—ã—Å–æ—Ç—É –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ */
        }

        .chat-box {
            flex: 1;
            overflow-y: auto;
            /* –î–æ–±–∞–≤–ª—è–µ–º –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—É—é –ø—Ä–æ–∫—Ä—É—Ç–∫—É */
            margin-bottom: 10px;
            white-space: pre-wrap;
            /* –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–æ–±–µ–ª—ã –∏ —Ç–∞–±—É–ª—è—Ü–∏–∏ */
            background-color: #000;
            /* –ß–µ—Ä–Ω—ã–π —Ñ–æ–Ω */
            border: 1px solid #8b0000;
            /* –¢–µ–º–Ω–æ-–∫—Ä–∞—Å–Ω–∞—è —Ä–∞–º–∫–∞ */
            padding: 10px;
        }

        .user-message,
        .bot-message {
            padding: 10px;
            margin: 5px 0;
            border-radius: 5px;
            word-wrap: break-word;
            /* –ü–µ—Ä–µ–Ω–æ—Å–∏–º —Å–ª–æ–≤–∞, –µ—Å–ª–∏ –æ–Ω–∏ —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω—ã–µ */
        }

        .user-message {
            background-color: #4b0000;
            /* –¢–µ–º–Ω–æ-–±–æ—Ä–¥–æ–≤—ã–π —Ñ–æ–Ω –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è */
            color: #fff;
            /* –ë–µ–ª—ã–π —Ç–µ–∫—Å—Ç */
            align-self: flex-end;
        }

        .bot-message {
            background-color: #660000;
            /* –¢–µ–º–Ω–æ-–∫—Ä–∞—Å–Ω—ã–π —Ñ–æ–Ω –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏–π –±–æ—Ç–∞ */
            color: #fff;
            /* –ë–µ–ª—ã–π —Ç–µ–∫—Å—Ç */
            align-self: flex-start;
        }

        input[type="text"] {
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            width: calc(100% - 22px);
            margin-bottom: 10px;
            background-color: #333;
            /* –¢–µ–º–Ω—ã–π —Ñ–æ–Ω –¥–ª—è –≤–≤–æ–¥–∞ —Ç–µ–∫—Å—Ç–∞ */
            color: #fff;
            /* –ë–µ–ª—ã–π —Ç–µ–∫—Å—Ç */
        }

        button {
            padding: 10px;
            border: none;
            border-radius: 5px;
            background: linear-gradient(to bottom, #ff0000, #8b0000);
            /* –ì—Ä–∞–¥–∏–µ–Ω—Ç –æ—Ç –∫—Ä–∞—Å–Ω–æ–≥–æ –¥–æ –±–æ—Ä–¥–æ–≤–æ–≥–æ */
            color: white;
            cursor: pointer;
        }

        button:hover {
            background: linear-gradient(to bottom, #ff4d4d, #8b0000);
            /* –ì—Ä–∞–¥–∏–µ–Ω—Ç –æ—Ç —Å–≤–µ—Ç–ª–æ-–∫—Ä–∞—Å–Ω–æ–≥–æ –¥–æ –±–æ—Ä–¥–æ–≤–æ–≥–æ –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ */
        }

        .code-container {
            position: relative;
            border: 1px solid #8b0000;
            /* –¢–µ–º–Ω–æ-–∫—Ä–∞—Å–Ω–∞—è —Ä–∞–º–∫–∞ */
            border-radius: 5px;
            padding: 10px;
            margin: 10px 0;
            background-color: #2c2c2c;
            /* –¢–µ–º–Ω—ã–π —Ñ–æ–Ω */
        }

        .copy-button {
            position: absolute;
            top: 10px;
            right: 10px;
            background: linear-gradient(to bottom, #ff0000, #8b0000);
            /* –ì—Ä–∞–¥–∏–µ–Ω—Ç –æ—Ç –∫—Ä–∞—Å–Ω–æ–≥–æ –¥–æ –±–æ—Ä–¥–æ–≤–æ–≥–æ */
            color: white;
            border: none;
            padding: 5px 10px;
            cursor: pointer;
            border-radius: 3px;
            transition: background-color 0.3s;
        }

        .copy-button:hover {
            background: linear-gradient(to bottom, #ff4d4d, #8b0000);
            /* –ì—Ä–∞–¥–∏–µ–Ω—Ç –æ—Ç —Å–≤–µ—Ç–ª–æ-–∫—Ä–∞—Å–Ω–æ–≥–æ –¥–æ –±–æ—Ä–¥–æ–≤–æ–≥–æ –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ */
        }

        .copy-button:active {
            background-color: #004080;
        }

        .icon {
            position: absolute;
            left: 10px;
            top: 10px;
            font-size: 15px;
        }

        .selectors {
            display: flex;
            gap: 20px;
            margin-bottom: 10px;
        }

        .model-selector,
        .style-selector {
            position: relative;
            display: inline-block;
        }

        .model-selector button,
        .style-selector button {
            background: linear-gradient(to bottom, #ff0000, #8b0000);
            /* –ì—Ä–∞–¥–∏–µ–Ω—Ç –æ—Ç –∫—Ä–∞—Å–Ω–æ–≥–æ –¥–æ –±–æ—Ä–¥–æ–≤–æ–≥–æ */
            color: white;
            border: none;
            padding: 10px;
            cursor: pointer;
            border-radius: 3px;
            transition: background-color 0.3s;
        }

        .model-selector button:hover,
        .style-selector button:hover {
            background: linear-gradient(to bottom, #ff4d4d, #8b0000);
            /* –ì—Ä–∞–¥–∏–µ–Ω—Ç –æ—Ç —Å–≤–µ—Ç–ª–æ-–∫—Ä–∞—Å–Ω–æ–≥–æ –¥–æ –±–æ—Ä–¥–æ–≤–æ–≥–æ –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ */
        }

        .model-menu,
        .style-menu {
            display: none;
            position: absolute;
            background-color: #2c2c2c;
            /* –¢–µ–º–Ω—ã–π —Ñ–æ–Ω */
            box-shadow: 0px 8px 16px 0px rgba(0, 0, 0, 0.2);
            z-index: 1;
        }

        .model-menu button,
        .style-menu button {
            color: white;
            padding: 12px 16px;
            text-decoration: none;
            display: block;
            width: 100%;
            border: none;
            background: none;
            text-align: left;
        }

        .model-menu button:hover,
        .style-menu button:hover {
            background-color: #8b0000;
            /* –¢–µ–º–Ω–æ-–∫—Ä–∞—Å–Ω–∞—è –∫–Ω–æ–ø–∫–∞ –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ */
        }

        .model-menu button .checkmark,
        .style-menu button .checkmark {
            display: none;
            margin-right: 75px;
        }

        .model-menu button.selected .checkmark,
        .style-menu button.selected .checkmark {
            display: contents;
        }

        .voice-button {
            padding: 10px;
            border: none;
            border-radius: 5px;
            background: linear-gradient(to bottom, #ff0000, #8b0000);
            /* –ì—Ä–∞–¥–∏–µ–Ω—Ç –æ—Ç –∫—Ä–∞—Å–Ω–æ–≥–æ –¥–æ –±–æ—Ä–¥–æ–≤–æ–≥–æ */
            color: white;
            cursor: pointer;
            margin-left: 10px;
        }

        .voice-button:hover {
            background: linear-gradient(to bottom, #ff4d4d, #8b0000);
            /* –ì—Ä–∞–¥–∏–µ–Ω—Ç –æ—Ç —Å–≤–µ—Ç–ª–æ-–∫—Ä–∞—Å–Ω–æ–≥–æ –¥–æ –±–æ—Ä–¥–æ–≤–æ–≥–æ –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ */
        }

        .orange-button {
            background: linear-gradient(to bottom, #ffa500, #ff4500) !important;
            /* –ì—Ä–∞–¥–∏–µ–Ω—Ç –æ—Ç –æ—Ä–∞–Ω–∂–µ–≤–æ–≥–æ –¥–æ —Ç–µ–º–Ω–æ-–æ—Ä–∞–Ω–∂–µ–≤–æ–≥–æ */
        }

        .orange-button:hover {
            background: linear-gradient(to bottom, #ffa500, #ff4500) !important;
            /* –ì—Ä–∞–¥–∏–µ–Ω—Ç –æ—Ç –æ—Ä–∞–Ω–∂–µ–≤–æ–≥–æ –¥–æ —Ç–µ–º–Ω–æ-–æ—Ä–∞–Ω–∂–µ–≤–æ–≥–æ –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ */
        }


        .character-panel {
            background: linear-gradient(to bottom, #000, #4a1517);
            /* –ì—Ä–∞–¥–∏–µ–Ω—Ç –æ—Ç –±–æ—Ä–¥–æ–≤–æ–≥–æ –¥–æ —á–µ—Ä–Ω–æ–≥–æ */
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(255, 0, 0, 0.5);
            /* –ö—Ä–∞—Å–Ω–∞—è —Ç–µ–Ω—å */
            padding: 20px;
            margin-left: 20px;
            width: 300px;
            /* –®–∏—Ä–∏–Ω–∞ –ø–∞–Ω–µ–ª–∏ */
            height: 80vh;
            /* –í—ã—Å–æ—Ç–∞ –ø–∞–Ω–µ–ª–∏ */
            overflow-y: auto;
            /* –í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–∞—è –ø—Ä–æ–∫—Ä—É—Ç–∫–∞ */
        }

        .character {
            margin-bottom: 20px;
        }

        .character h3 {
            margin: 0;
            padding: 0;
            font-size: 1.2em;
            color: #ff0000;
            /* –ö—Ä–∞—Å–Ω—ã–π —Ü–≤–µ—Ç –¥–ª—è –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ */
        }

        .character p {
            margin: 5px 0;
            padding: 0;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #2e0b0b;
            transition: .4s;
            border-radius: 34px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked+.slider {
            background-color: #a52a2a;
        }

        input:checked+.slider:before {
            transform: translateX(26px);
        }
    </style>
</head>

<body>
    <div class="chat-container">
        <div class="selectors">
            <div class="model-selector">
                <button onclick="toggleModelMenu()">–í—ã–±—Ä–∞—Ç—å –º–æ–¥–µ–ª—å</button>
                <div class="model-menu" id="model-menu">
                    <button onclick="selectModel('gpt-4o-mini')" id="model-gpt-4o-mini"><span class="checkmark">‚úî
                        </span>GPT-4o-mini</button>
                    <button onclick="selectModel('blackbox')" id="model-blackbox"><span class="checkmark">‚úî
                        </span>Gemini</button>
                    <button onclick="selectModel('pizzagpt')" id="model-pizzagpt"><span class="checkmark">‚úî </span>GPT-4
                        V1</button>
                    <button onclick="selectModel('ddg')" id="model-ddg"><span class="checkmark">‚úî </span>GPT-4
                        V2</button>
                </div>
            </div>
            <label class="switch">
                <input type="checkbox" id="toggle-images" onchange="toggleImages()">
                <span class="slider"></span>
            </label>
            <label for="toggle-images">–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è</label>
            <label class="switch">
                <input type="checkbox" id="toggle-sounds" onchange="toggleSounds()">
                <span class="slider"></span>
            </label>
            <label for="toggle-sounds">–ó–≤—É–∫–∏</label>
            <label class="switch">
                <input type="checkbox" id="toggle-voice" onchange="toggleVoice()">
                <span class="slider"></span>
            </label>
            <label for="toggle-voice">–û–∑–≤—É—á–∏–≤–∞–Ω–∏–µ</label>
        </div>
        <div class="chat-box" id="chat-box"></div>

        <div id="welcome-message" class="bot-message" , align="center">

		–ü—É—Ç–Ω–∏–∫–∏, –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤—É—é –≤–∞—Å –≤ –∏–≥—Ä–µ "–ü–æ–¥–∑–µ–º–µ–ª—å—è –∏ –î—Ä–∞–∫–æ–Ω—ã", –≥–¥–µ —Å—é–∂–µ—Ç –∏ –∞—Ç–º–æ—Å—Ñ–µ—Ä–∞ —Å–æ–∑–¥–∞—é—Ç—Å—è –Ω–µ–π—Ä–æ—Å–µ—Ç—è–º–∏! 


		–î–ª—è –Ω–∞—á–∞–ª–∞ –∏–≥—Ä—ã –º–æ–∂–µ—Ç–µ –≤—ã–±—Ä–∞—Ç—å –Ω–µ–π—Ä–æ—Å–µ—Ç—å –ø–æ —Å–≤–æ–µ–º—É –∂–µ–ª–∞–Ω–∏—é.


		–ú–æ–∂–µ—Ç–µ –Ω–∞–ø–∏—Å–∞—Ç—å –≤ –ø–µ—Ä–≤–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏ (–¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∏–≥—Ä–æ–∫–∞): –∫—Ç–æ –≤—ã, –≥–¥–µ –≤—ã, —á—Ç–æ —Å–æ–±–∏—Ä–∞–µ—Ç–µ—Å—å —Å–¥–µ–ª–∞—Ç—å, –≤–∞—à–∏ —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏ –∏–ª–∏ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏.

        –ù–µ–π—Ä–æ—Å–µ—Ç—å –æ—Ç–≤–µ—Ç–∏—Ç —Å—é–∂–µ—Ç–æ–º, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–º –≤–∞—à–∏–º –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º.

        –ü—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –ø—É—Å—Ç–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è ‚Äì –Ω–µ–π—Ä–æ—Å–µ—Ç—å —Å–∞–º–∞ —Å–≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π, –ª–æ–∫–∞—Ü–∏—é –∏ —Å–æ–±—ã—Ç–∏—è.


		–î–ª—è –≤–∫–ª—é—á–µ–Ω–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –∏ –∑–≤—É–∫–æ–≤ –ø–µ—Ä–µ–∫–ª—é—á–∏—Ç–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π —á–µ–∫–±–æ–∫—Å.  –î–ª—è –ø–µ—Ä–µ–¥–∞—á–∏ —Å–æ–æ–±—â–µ–Ω–∏–π –≥–æ–ª–æ—Å–æ–º ‚Äì –≤–∫–ª—é—á–∏—Ç–µ –º–∏–∫—Ä–æ—Ñ–æ–Ω.  

		–¢–µ–∫—Å—Ç –∏ –∑–≤—É–∫–∏ –≥–µ–Ω–µ—Ä–∏—Ä—É—é—Ç—Å—è –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏, –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è - –¥–æ –º–∏–Ω—É—Ç—ã.  –ï—Å–ª–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –¥–æ–ª–≥–æ ‚Äì –º–æ–∂–Ω–æ  –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å –∏–≥—Ä—É, –Ω–µ –¥–æ–∂–∏–¥–∞—è—Å—å –µ–≥–æ, –Ω–∞–∂–∞–≤ ¬´–û—Ç–º–µ–Ω–∞¬ª –≤ Push-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–∏, –∫–æ—Ç–æ—Ä–æ–µ –ø–æ—è–≤–ª—è–µ—Ç—Å—è –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥. 



		–ü–æ –≤—Å–µ–º –≤–æ–ø—Ä–æ—Å–∞–º –∏ –ø–æ–∂–µ–ª–∞–Ω–∏—è–º –æ–±—Ä–∞—â–∞–π—Ç–µ—Å—å –≤ Telegram: @kidborg –∏–ª–∏ –í–ö–æ–Ω—Ç–∞–∫—Ç–µ: https://vk.com/kidborg 


		–£–≤–ª–µ–∫–∞—Ç–µ–ª—å–Ω–æ–≥–æ –ø—É—Ç–µ—à–µ—Å—Ç–≤–∏—è! 

        </div>

        <input type="text" id="user-input" placeholder="Type your message here...">
        <button onclick="sendMessage()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
        <button id="start-recording-button" onclick="startRecording()">üé§ –ù–∞—á–∞—Ç—å –∑–∞–ø–∏—Å—å</button>
        <button onclick="stopRecording()">üõë –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–ø–∏—Å—å</button>
    </div>
    <div class="character-panel">
        <!-- Character panel content will be dynamically generated -->
    </div>

    <script>
        const fetchTimeout = (url, options, timeout = 3000) => {
            const controller = new AbortController();
            const id = setTimeout(() => controller.abort(), timeout); // –í—Ä–µ–º—è –≤—ã—à–ª–æ! 
            return fetch(url, { ...options, signal: controller.signal })
                .finally(() => clearTimeout(id));
        };

        document.addEventListener('DOMContentLoaded', function () {
            const chatBox = document.getElementById('chat-box');
            const welcomeMessage = document.getElementById('welcome-message');
            chatBox.appendChild(welcomeMessage);

            // Add event listener for Enter key
            document.getElementById('user-input').addEventListener('keydown', function (event) {
                if (event.key === 'Enter') {
                    sendMessage();
                }
            });
        });


        let selectedModel = 'gpt-4o'; // Default model
        let selectedStyle = 'calm'; // Default style
        let recognition;
        let imagesEnabled = document.getElementById('toggle-images').checked; // Default state for images
        let soundsEnabled = document.getElementById('toggle-sounds').checked; // Default state for sounds
        let voiceEnabled = document.getElementById('toggle-voice').checked; // Default state for voice

        let voice_b64;
        let sound_b64;
        let image_b64;

        let generating_response = false; // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –ª–∏ —Å–µ–π—á–∞—Å –æ—Ç–≤–µ—Ç
        let cancel_image_gen = false; // –û—Ç–º–µ–Ω–∏—Ç—å –ª–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏—é –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
        let counter = 0; // –°—á—ë—Ç—á–∏–∫ –∑–∞–ø—Ä–æ—Å–æ–≤ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
        let lastQuestion = ''

        function toggleModelMenu() {
            const menu = document.getElementById('model-menu');
            menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
        }

        function toggleStyleMenu() {
            const menu = document.getElementById('style-menu');
            menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
        }

        function selectModel(model) {
            selectedModel = model;
            toggleModelMenu();
            console.log('Selected model:', selectedModel);

            // Update checkmarks
            const buttons = document.querySelectorAll('.model-menu button');
            buttons.forEach(button => {
                button.classList.remove('selected');
            });
            document.getElementById(`model-${model}`).classList.add('selected');
        }

        function selectStyle(style) {
            selectedStyle = style;
            toggleStyleMenu();
            console.log('Selected style:', selectedStyle);

            // Update checkmarks
            const buttons = document.querySelectorAll('.style-menu button');
            buttons.forEach(button => {
                button.classList.remove('selected');
            });
            document.getElementById(`style-${style}`).classList.add('selected');
        }

        function toggleImages() {
            imagesEnabled = !imagesEnabled;
            console.log('Images enabled:', imagesEnabled);
        }

        function toggleSounds() {
            soundsEnabled = !soundsEnabled;
            console.log('Sounds enabled:', soundsEnabled);
        }

        function toggleVoice() {
            voiceEnabled = !voiceEnabled;
            console.log('Voice enabled:', voiceEnabled);
        }

        async function sendMessage() {
            if (generating_response) {
                alert('–ü—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∞ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è, –ø–æ–¥–æ–∂–¥–∏—Ç–µ! (–≠—Ç–æ –º–æ–∂–µ—Ç –±—ã—Ç—å –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–∞, –æ–∑–≤—É—á–∏–≤–∞–Ω–∏—è, –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –∏–ª–∏ –∑–≤—É–∫–æ–≤)');
                return;
            }

            generating_response = true;

            const userInput = document.getElementById('user-input').value;

            console.log("User input:", userInput);

            // Replace ***text*** with <b>text</b>
            const formattedUserInput = userInput.replace(/\*\*\*(.*?)\*\*\*/g, '<b>$1</b>');

            let userMessages = document.getElementsByClassName('user-message')
            let botMessages = document.getElementsByClassName('bot-message')
            let charactersPanels = document.getElementsByClassName('character')
            let hasHistory = userMessages.length > 0

            let history
            let question
            let answer
            let characters = ''

            if (hasHistory) {
                history = ''
		tillMessage = userMessages.length - 3
		if (tillMessage < 0) tillMessage = 0;
                for (let i = userMessages.length - 1; i > tillMessage; i--) {
                    if (botMessages[i].textContent != '–û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Å–æ–±—ã—Ç–∏—è, –ø–æ–≤—Ç–æ—Ä–∏—Ç–µ –æ—Ç–≤–µ—Ç –∏–ª–∏ –≤—ã–±–µ—Ä–∏—Ç–µ –¥—Ä—É–≥—É—é –º–æ–¥–µ–ª—å –Ω–µ–π—Ä–æ—Å–µ—Ç–∏') {
                        history += botMessages[i].textContent + "\n"
                        // history += userMessages[i].textContent + "\n"
                    }
                }
                question = lastQuestion
                answer = userMessages[userMessages.length - 1].textContent
                for (let i = 0; i < charactersPanels.length; i++) {
                    characters += charactersPanels[i].textContent + "\n"
                }
            }

            let body

            if (hasHistory) {
                body = JSON.stringify({
                    message: userInput,
                    model: selectedModel,
                    style: selectedStyle,
                    hasHistory: "True",
                    history: history,
                    question: question,
                    characters: characters
                })
            } else {
                body = JSON.stringify({
                    message: userInput,
                    model: selectedModel,
                    style: selectedStyle,
                    hasHistory: "False"
                })
            }

            const chatBox = document.getElementById('chat-box');

            // Add user message to chat box
            chatBox.innerHTML += `<div class="user-message">${userInput}</div>`;
            document.getElementById('user-input').value = '';

            // Scroll to the bottom of the chat box
            chatBox.scrollTop = chatBox.scrollHeight;

            // Send message to the server
            const response = await fetch(window.location.href + 'chat', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: body
            });
            const data = await response.json();

            console.log("Bot response:", data.message);

            // Replace ***text*** with <b>text</b> in bot response
            const formattedBotResponse = data.message.replace(/\*\*\*(.*?)\*\*\*/g, '<b>$1</b>');
            if (formattedBotResponse != '–û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Å–æ–±—ã—Ç–∏—è, –ø–æ–≤—Ç–æ—Ä–∏—Ç–µ –æ—Ç–≤–µ—Ç –∏–ª–∏ –≤—ã–±–µ—Ä–∏—Ç–µ –¥—Ä—É–≥—É—é –º–æ–¥–µ–ª—å –Ω–µ–π—Ä–æ—Å–µ—Ç–∏') {
                lastQuestion = formattedBotResponse;
            }

  	    delayPrintMessage(formattedBotResponse, data)

            if (voiceEnabled) {
                voice_b64 = await request_voice(data.message);
                textPlay();
            }

            if (soundsEnabled) {
                sound_b64 = await request_sound(data.message);
                soundPlay();
            }

            if (imagesEnabled) {
                image_b64 = await request_image(data.message);
                Image();
            }

            generating_response = false;
        }

        function startRecording() {
            const startButton = document.getElementById('start-recording-button');
	    if (startButton.classList.contains('orange-button')) {
		return;
	    }
            startButton.classList.add('orange-button');
            if (!('webkitSpeechRecognition' in window)) {
                alert('–í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç Web Speech API. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ Google Chrome.');
                return;
            }

            recognition = new webkitSpeechRecognition();
            recognition.continuous = true; // Continuous recognition
            recognition.interimResults = false;
            recognition.lang = 'ru-RU'; // Set language to Russian

            recognition.onstart = function () {
                console.log('Voice recognition started.');
            };

            recognition.onresult = function (event) {
                const transcript = event.results[event.resultIndex][0].transcript;
                document.getElementById('user-input').value += transcript;
                console.log('Voice input:', transcript);
                sendMessage(); // Automatically send the message after voice input
            };

            recognition.onerror = function (event) {
                console.error('Voice recognition error:', event.error);
                alert('–ú–∏–∫—Ä–æ—Ñ–æ–Ω –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω');
                stopRecording();
            };

            recognition.onend = function () {
                console.log('Voice recognition ended.');
                if (recognition) {
                    recognition.start(); // Restart recognition if it ends
                }
            };

            recognition.start();
        }

        function stopRecording() {
            const startButton = document.getElementById('start-recording-button');
            startButton.classList.remove('orange-button');
            startButton.classList.add('start-button');
            if (recognition) {
                recognition.stop();
                console.log('Voice recognition stopped.');
                recognition = null; // Clear the recognition object
            }
        }

        // Set default selected model and style
        document.getElementById(`model-${selectedModel}`).classList.add('selected');
        document.getElementById(`style-${selectedStyle}`).classList.add('selected');

        // Add event listener for Enter key
        document.getElementById('user-input').addEventListener('keydown', function (event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        });

        async function request_sound(message) {
            const response = await fetch(window.location.href + 'get_sound', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    message: message
                })
            });
            const sound_data = await response.json();
            return sound_data.sound;
        }

        async function request_voice(message) {
            const response = await fetch(window.location.href + 'get_voice', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    message: message
                })
            });
            const voice_data = await response.json();
            return voice_data.voice;
        }


        async function request_image(message) {
            const response = await fetch(window.location.href + 'get_image', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    message: message,
                })
            });
            const reply = await response.json();
            const uuid = reply.uuid;
            counter = 0;

            while (counter <= 10) {
                const response = await fetch(window.location.href + 'get_image', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: message,
                        uuid: uuid
                    })
                });
                let reply_new = await response.json()

                if (reply_new.is_ready == 'True') {
                    counter = 0;
                    return reply_new.image;
                }

                counter += 1;
                console.log("–ü–æ–ø—ã—Ç–∫–∞ –∑–∞–ø—Ä–æ—Å–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ: " + counter);

                if (counter > 1 && ! confirm('–ï—Å–ª–∏ —Ö–æ—Ç–∏—Ç–µ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å –≥–µ–Ω–µ—Ä–∞—Ü–∏—é –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è, —Ç–æ –Ω–∞–∂–º–∏—Ç–µ ¬´–û–ö¬ª'))
                    break;

                await new Promise(resolve => setTimeout(resolve, 30000));
            }

            return '';
        }
	
	async function delayPrintMessage(formattedBotResponse, data) {
            const chatBox = document.getElementById('chat-box');

    	    if (imagesEnabled) {
                await new Promise(resolve => setTimeout(resolve, 5000));
	    }
	
            // Add bot response to chat box
            chatBox.innerHTML += `<div class="bot-message">${formattedBotResponse.replace(/\n/g, '<br>')}</div>`;

            // Scroll to the bottom of the chat box
            chatBox.scrollTop = chatBox.scrollHeight;

            const characterPanel = document.querySelector('.character-panel');
            characterPanel.innerHTML = '';
            for (const [character, stats] of Object.entries(data.characters)) {
                const characterDiv = document.createElement('div');
                characterDiv.classList.add('character');
                if (stats['–∑–¥–æ—Ä–æ–≤—å–µ'] == 0) {
                    characterDiv.innerHTML =
                        `<h3>${character}</h3>
                        <p>–£–º–µ—Ä üíÄ</p>`;
                    characterPanel.appendChild(characterDiv);
                } else {
                    characterDiv.innerHTML =
                        `<h3>${character}</h3>
                        <p>–ó–¥–æ—Ä–æ–≤—å–µ: ${stats['–∑–¥–æ—Ä–æ–≤—å–µ']}</p>
                        <p>–°–∏–ª–∞: ${stats['—Å–∏–ª–∞']}</p>
                        <p>–ó–∞—â–∏—Ç–∞: ${stats['–∑–∞—â–∏—Ç–∞']}</p>
                        <p>–≠–Ω–µ—Ä–≥–∏—è: ${stats['—ç–Ω–µ—Ä–≥–∏—è']}</p>
                        <p>–ò–Ω—Ç–µ–ª–ª–µ–∫—Ç: ${stats['–∏–Ω—Ç–µ–ª–ª–µ–∫—Ç']}</p>
                        <p>${stats['–æ–ø–∏—Å–∞–Ω–∏–µ']}</p>`;
                    characterPanel.appendChild(characterDiv);
                }
            }
	}
    </script>
    <script>
        function soundPlay() {
            console.log("Sound 1");
            if (sound_b64 == '') {
                alert('–ó–≤—É–∫–∏ –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ');
            }
            new Audio("data:audio/mp3;base64," + sound_b64).play()
        }

        function textPlay() {
            console.log("Sound 2")
            if (voice_b64 == '') {
                alert('–û–∑–≤—É—á–∏–≤–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ');
            }
            new Audio("data:audio/mp3;base64," + voice_b64).play()
        }

        function Image() {
            const chatBox = document.getElementById('chat-box');
            const img = document.createElement('img');
            img.src = 'data:image/jpg;base64,' + image_b64; // –î–æ–±–∞–≤–ª—è–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –ø–∞—Ä–∞–º–µ—Ç—Ä
            img.alt = 'Image';
            img.style.maxWidth = '35%'; // Ensure the image fits within the chat box
            chatBox.appendChild(img);
            chatBox.scrollTop = chatBox.scrollHeight; // Scroll to the bottom of the chat box
        }
    </script>
</body>

</html>
